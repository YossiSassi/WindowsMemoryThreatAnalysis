# Windows Memory Threat Analysis
PowerShell module for comprehensive memory threat analysis for process memory regions. Scan a process for suspicious patterns, map memory regions to threads; then analyze for threats &amp; produce a detailed report.
<br><br>
Contains of 2 scripts:<br>
1. <p>Get-RWXAndMapThreads.ps1</p> Scan a process for suspicious executable memory (exec+write and exec-only) and map detected memory regions to threads whose Start Address address lies inside them.<br>
2. <p>Invoke-MemoryThreatAnalysis.ps1</p> Takes the output json file from 'Get-RWXAndMapThreads.ps1' and analyzes it for threat injection, NOP sleds, syscall stubs, trampoline regions, RWX regions, high-entropy payloads, suspicious strings and more. Output to console + a dark-themed detailed HTML report. (Note: Requires Python 3.x for JSON parsing of large/concatenated JSON arrays)<br>
### Memory Threat Analysis Flow ###
Malicious bytes might reside in threads in memory - this is represented in step 1. The first script, 'Get-RWXAndMapThreads.ps1', is represented by step 2: You scan one or more processes and produce a json file. The second script, 'Invoke-MemoryThreatAnalysis.ps1', is represented in steps 3 + 4: analyzing the output json file for multiple threat patterns, and producing a detailed html report:
![memory threat analysis flow](/screenshots/memorythreatanalysisflow.jpg) <br>
### Get-RWXAndMapThreads.ps1 ###
.SYNOPSIS<br>
  Scan a process for suspicious executable memory (exec+write and exec-only) and map detected memory regions to threads whose Start Address address lies inside them.<br>
  can be later leveraged for memory threat analysis of threat injection, NOP sleds, syscall stubs, trampoline regions, RWX regions, high-entropy payloads, suspicious strings and more.<br>
  The output json file can later be loaded into 'Invoke-MemoryThreatAnalysis.ps1' for a comprehensive memory threat analysis and a detailed HTML report.<br><br>

.NOTES<br>
  - Run elevated (Administrator).<br>
  - Use matching bitness (64-bit PowerShell for 64-bit target).<br>
  - This script reads memory (safe). It does not write or inject.<br><br>
  
 .EXAMPLE<br>
Scan a process for default string ('MZ'), 4096 bytes read (can set to less or more bytes)
```
& C:\temp\Get-RWXAndMapThreads.ps1 -ProcessID 11804 -ExportJson C:\temp\ProcMemory.json
```
Scan all processes and save into a json file
```
Get-Process | ForEach-Object { & C:\temp\Get-RWXAndMapThreads.ps1 -ProcessID $_.id -ExportJson C:\temp\memory.json -StringToLookFor 'MZ'}
```

### Invoke-MemoryThreatAnalysis.ps1 ###
.SYNOPSIS<br>
    Comprehensive memory threat analysis script for process memory region JSON data.<br>
    Use 'Get-RWXAndMapThreads.ps1' to generate the input json file.<br><br>

.DESCRIPTION<br>
    Analyzes JSON output from memory scanning tools (e.g., Get-RWXAndMapThreads) to detect<br>
    suspicious patterns including: RWX regions, MZ/PE headers, NOP sleds, syscall stubs,trampolines, INT3 patterns, high-entropy regions, suspicious strings and active threads.<br>
    Generates a per-process risk assessment and outputs an HTML report.<br>
    Uses an input json file generated by 'Get-RWXAndMapThreads.ps1' script.<br><br>

.PARAMETER JsonFilePath<br>
    Path to the memory.json file to analyze. Defaults to memory.json in the script directory.<br><br>

.PARAMETER HtmlReportPath<br>
    Path for the HTML report output. Defaults to findings.htm in the script directory.<br><br>

.PARAMETER RiskThreshold<br>
    Minimum risk score to flag a process as high-risk. Default: 500.<br><br>

.NOTES<bR>
    Requires Python 3.x for JSON parsing of large/concatenated JSON arrays.<br>
    Author: Claude Opus 4.6 - Memory Threat Analyzer<br>
    Prompt design & AI implementation plan: Yossi Sassi<br><br>

.EXAMPLE<br>
Run with defaults
```
.\Invoke-MemoryThreatAnalysis.ps1
```
Run with setting input Json file path and ouput html report path
```
.\Invoke-MemoryThreatAnalysis.ps1 -JsonFilePath C:\data\memory.json -HtmlReportPath C:\reports\findings.htm
```
### Sample Screenshots ###
High risk analysis (post-scan) - detected injected mimikatz that bypassed EDR
![High risk analysis - injected malicious detection](/screenshots/screenshot_analysis_high_mimi.jpg) <br><br>

Low risk scan - PowerShell & PWSH
![Low risk scan - PowerShell & PWSH](/screenshots/screenshot_sample_scan_ps.jpg) <br><br>

Analysis of low risk PowerShell & PWSH - Part 1
![Analysis of low risk PowerShell & PWSH - Part 1](/screenshots/screenshot_analysis_ps1.jpg) <br><br>

Analysis of low risk PowerShell & PWSH - Part 2
![Analysis of low risk PowerShell & PWSH - Part 2](/screenshots/screenshot_analysis_ps2.jpg) <br><br>

Scan with suspicious bytes in memory
![Scan with suspicious hex in thread](/screenshots/screenshot_sample_scan_malicious.jpg) <br><br>

Analysis of medium risk score with suspicious bytes (See also sample html report)
![Analysis of medium risk score with suspicious bytes](/screenshots/screenshot_analysis_calc.jpg) <br>
### Sample Report ###
Sample HTML findings report can be found [View Report](./reports/sample-findings-report.htm)<br><br>
Suggestions & comments are welcome to yossis@protonmail.com
